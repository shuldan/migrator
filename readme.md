# `migrator` â€” ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ Ð¸ Ð½Ð°Ð´Ñ‘Ð¶Ð½Ñ‹Ð¹ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚ Ð´Ð»Ñ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸ÑÐ¼Ð¸ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ð° Go

[![Go CI](https://github.com/shuldan/migrator/workflows/Go%20CI/badge.svg)](https://github.com/shuldan/migrator/actions)
[![codecov](https://codecov.io/gh/shuldan/migrator/branch/main/graph/badge.svg)](https://codecov.io/gh/shuldan/migrator)
[![Go Report Card](https://goreportcard.com/badge/github.com/shuldan/migrator)](https://goreportcard.com/report/github.com/shuldan/migrator)
[![License: MIT](https://img.shields.io/badge/License-MIT-blue.svg)](https://opensource.org/licenses/MIT)

ÐŸÐ°ÐºÐµÑ‚ `migrator` Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹, Ñ‚Ð¸Ð¿Ð¾Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ð¹ Ð¸ Ñ€Ð°ÑÑˆÐ¸Ñ€ÑÐµÐ¼Ñ‹Ð¹ ÑÐ¿Ð¾ÑÐ¾Ð± ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸ÑÐ¼Ð¸ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð² Go-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸ÑÑ…. ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ Ð¿Ð°ÐºÐµÑ‚Ð½Ð¾Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹, Ð¾Ñ‚ÐºÐ°Ñ‚ (`rollback`) Ð¸ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ñ‡ÐµÑ€ÐµÐ· ÑÐ»ÑƒÐ¶ÐµÐ±Ð½ÑƒÑŽ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ `schema_migrations`.

---

## ðŸš€ ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸

- **Ð”ÐµÐºÐ»Ð°Ñ€Ð°Ñ‚Ð¸Ð²Ð½Ð¾Ðµ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹**: ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ ÑƒÐ´Ð¾Ð±Ð½Ð¾Ð³Ð¾ builder-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ°.
- **ÐŸÐ°ÐºÐµÑ‚Ð½Ð¾Ðµ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ**: Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€ÑƒÑŽÑ‚ÑÑ Ð² Ð±Ð°Ñ‚Ñ‡Ð¸ Ð´Ð»Ñ Ð°Ñ‚Ð¾Ð¼Ð°Ñ€Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¸ Ð¾Ñ‚ÐºÐ°Ñ‚Ð°.
- **Ð¢Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ð¸Ð¾Ð½Ð½Ð°Ñ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ**: ÐºÐ°Ð¶Ð´Ð°Ñ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ñ Ð¸Ð»Ð¸ Ð³Ñ€ÑƒÐ¿Ð¿Ð° Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ Ð² Ð¾Ð´Ð½Ð¾Ð¹ Ñ‚Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ð¸Ð¸.
- **ÐžÑ‚ÐºÐ°Ñ‚ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹**: Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° `Down()`-Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¼ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸ÐµÐ¼ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð¸Ð· Ð¼ÐµÑ‚Ð°-Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹.
- **ÐÐµÐ·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑŒ Ð¾Ñ‚ Ð¡Ð£Ð‘Ð”**: Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ñ Ð»ÑŽÐ±Ñ‹Ð¼ Ð´Ñ€Ð°Ð¹Ð²ÐµÑ€Ð¾Ð¼ `database/sql` (Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð»ÑÑ Ñ SQLite3).
- **Ð¡Ñ‚Ñ€Ð¾Ð³Ð°Ñ Ñ‚Ð¸Ð¿Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¸ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ**: Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð¿Ñ€Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ð¸ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹ Ð¾Ð±Ð¾Ñ€Ð°Ñ‡Ð¸Ð²Ð°ÑŽÑ‚ÑÑ Ð² Ð¿Ð¾Ð½ÑÑ‚Ð½Ñ‹Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸.

---

## ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð¸ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²

Ð”Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð¾Ð¼ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Go **1.24+**.

Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð´Ð»Ñ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸:

```sh
make install-tools
```

Ð­Ñ‚Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚:
- `golangci-lint` (v2.4.0)
- `goimports`
- `gosec`

---

## ðŸ› ï¸ Ð Ð°Ð±Ð¾Ñ‚Ð° Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð¾Ð¼

### Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°

```sh
make all
```

Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚:
- Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ÐºÐ¾Ð´Ð°,
- ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð· (`golangci-lint`),
- security-ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ (`gosec`),
- Ð·Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ð¾Ð².

### ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð² CI

```sh
make ci
```

Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚:
- Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸ÑŽ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ,
- `go vet`,
- Ð»Ð¸Ð½Ñ‚ÐµÑ€,
- Ñ‚ÐµÑÑ‚Ñ‹ Ñ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð¾Ð¼ Ð¾ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ð¸ (Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ 70%).

### Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð´Ð°

```sh
make fmt
```

ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ Ñ„Ð°Ð¹Ð»Ñ‹ `.go` Ð¸ ÑÐ¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ñ‹ ÑÐ¾Ð³Ð»Ð°ÑÐ½Ð¾ `local-prefixes`.

### Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ð¾Ð²

```sh
make test
make test-coverage
```

---

## ðŸ§± ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð°

### `Migration`

Ð˜Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸:

```go
type Migration interface {
	ID() string
	Description() string
	Up() []string   // Ð—Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
	Down() []string // Ð—Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð´Ð»Ñ Ð¾Ñ‚ÐºÐ°Ñ‚Ð°
}
```

### `MigrationBuilder`

ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð´ÐµÐºÐ»Ð°Ñ€Ð°Ñ‚Ð¸Ð²Ð½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸:

```go
migration := migrator.CreateMigration("001", "create users table").
    CreateTable("users",
        "id INTEGER PRIMARY KEY",
        "name TEXT NOT NULL",
        "email VARCHAR(255) UNIQUE",
    ).
    CreateIndex("idx_users_email", "users", "email").
    Build()
```

ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÐ¼Ñ‹Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸:
- `CreateTable` / `DropTable`
- `AddColumn` / `DropColumn` / `RenameColumn` / `ChangeColumn`
- `CreateIndex` / `CreateUniqueIndex` / `DropIndex`
- `AddForeignKey` / `DropForeignKey`
- `AddPrimaryKey` / `AddCheck`
- `Raw`, `RawUp`, `RawDown` â€” Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð»ÑŒÐ½Ñ‹Ñ… SQL-Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²

### `Migrator`

ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð¾Ð±ÑŠÐµÐºÑ‚ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸ÑÐ¼Ð¸:

```go
m := migrator.New(db)
m.Register(migration1, migration2, ...) // Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹
err := m.Up()                           // Ð¿Ñ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸
err := m.Down(2)                        // Ð¾Ñ‚ÐºÐ°Ñ‚Ð¸Ñ‚ÑŒ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 2 Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸
status, err := m.Status()               // Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¿Ñ€Ð¸Ð¼ÐµÐ½Ñ‘Ð½Ð½Ñ‹Ñ… Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹
```

---

## ðŸ§ª ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ

```go
package main

import (
	"database/sql"
	"log"

	_ "github.com/mattn/go-sqlite3"
	"github.com/shuldan/migrator"
)

func main() {
	db, err := sql.Open("sqlite3", "./test.db")
	if err != nil {
		log.Fatal(err)
	}
	defer db.Close()

	m1 := migrator.CreateMigration("001", "create users").
		CreateTable("users", "id INTEGER PRIMARY KEY", "name TEXT").
		Build()

	m2 := migrator.CreateMigration("002", "add email").
		AddColumn("users", "email VARCHAR(255)").
		Build()

	m := migrator.New(db)
	m.Register(m1, m2)

	// ÐŸÑ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð½ÐµÐ¿Ñ€Ð¸Ð¼ÐµÐ½Ñ‘Ð½Ð½Ñ‹Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸
	if err := m.Up(); err != nil {
		log.Fatal(err)
	}

	// ÐŸÐ¾Ð·Ð¶Ðµ â€” Ð¾Ñ‚ÐºÐ°Ñ‚Ð¸Ñ‚ÑŒ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 2 Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸
	if err := m.Down(2); err != nil {
		log.Fatal(err)
	}
}
```

---

## ðŸ“„ Ð›Ð¸Ñ†ÐµÐ½Ð·Ð¸Ñ

ÐŸÑ€Ð¾ÐµÐºÑ‚ Ñ€Ð°ÑÐ¿Ñ€Ð¾ÑÑ‚Ñ€Ð°Ð½ÑÐµÑ‚ÑÑ Ð¿Ð¾Ð´ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸ÐµÐ¹ [MIT](LICENSE).

---

## ðŸ¤ Ð’ÐºÐ»Ð°Ð´ Ð² Ð¿Ñ€Ð¾ÐµÐºÑ‚

PR Ð¸ issue Ð¿Ñ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚ÑÑ! Ð¡Ð¾Ð±Ð»ÑŽÐ´Ð°Ð¹Ñ‚Ðµ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ (`make fmt-check`) Ð¸ Ð¿Ð¾ÐºÑ€Ñ‹Ð²Ð°Ð¹Ñ‚Ðµ Ð½Ð¾Ð²Ñ‹Ð¹ ÐºÐ¾Ð´ Ñ‚ÐµÑÑ‚Ð°Ð¼Ð¸.

---

> **ÐÐ²Ñ‚Ð¾Ñ€**: MSeytumerov  
> **Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹**: `github.com/shuldan/migrator`  
> **Go**: `1.24.2`  